{"version":3,"sources":["../src/index.js"],"names":["_logger","Logger","_filePaths","FilePaths","_puppeteerConfig","headless","width","height","args","_puppeteerWrapper","PuppeteerWrapper","countryCode","main","searchLimit","parseInt","process","argv","cities","Model","CityName","findAll","categories","CategoryName","keywords","forEach","city","category","searchQuery","name","push","query","id","i","length","keyword","GMapScrapper","delay","range","changeLocation","page","locationMenuSelector","waitForSelector","click","moreRegionLinkSelector","waitUntil","waitForTimeout","changeLanguage","getPageData","url","console","log","goto","itemName","$eval","cssSelector","textContent","reviewRating","rating","reviewCount","review","exception","error","address","$$eval","divs","Array","from","map","div","innerText","find","undefined","timeout","ex","website","link","test","phone","latLong","getLatLong","workHours","JSON","stringify","getWorkHours","images","getImages","allReviews","getReviews","returnObj","trim","reviews","replace","latitude","toString","substring","longitude","main_image","all_images","all_reviews","waitForNavigation","newScrollHeight","scrollHeight","divSelector","evaluate","document","querySelector","scrollTo","getComputedStyle","backgroundImage","replaceAll","btnTriggerSelector","elHandles","el","replaceString","dateInEnglish","key","Object","hasOwnProperty","call","replacement","reviewText","startTrimIndex","indexOf","author","title","avatar","getAttribute","text","date","reviewData","format","tableSelector","getLinks","searchResults","querySelectorAll","href","filter","match","latLongStartIndex","latLongEndIndex","latLongData","split","isNaN","slugify","str","toLowerCase","to","l","RegExp","charAt","maxLinks","newPage","gmapInitUrl","Date","now","on","response","status","headers","dialog","accept","reload","type","keyboard","press","allLinks","linkCount","elements","some","uniqueLinks","value","index","self","slice","no","successCount","failedCount","item","Item","findOne","where","data","create","slug","hours_of_work","image_remote","image","date_created","item_city","City","cities_names_id","items_id","existingItemCategory","Category","categories_names_id","imageUrl","existingImage","Image","existingReview","Comment","cleanup","doneMessage","chromeSet","setup","_getSavedPath","e","logError","exportLogs","logsPath"],"mappings":"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","file":"index.js","sourcesContent":["//#region Imports\r\n// Library ----------------------------------------------------------------------------------\r\nimport { Logger } from './lib/logger';\r\nimport { FilePaths } from './lib/file-paths.js';\r\nimport { PuppeteerWrapper } from './lib/puppeteer-wrapper';\r\nimport { CSS_SELECTOR as cssSelector } from './config';\r\nimport Model from './lib/model';\r\nimport $ from 'jquery';\r\nimport delay from 'delay';\r\nimport datejs from 'date.js';\r\nimport moment from 'moment';\r\n//#endregion\r\n\r\n//#region Setup - Dependency Injection-----------------------------------------------\r\nconst _logger = new Logger();\r\nconst _filePaths = new FilePaths(_logger, \"gmap-scrapper\");\r\nconst _puppeteerConfig = { headless: true, width: 900, height: 650, args: ['--lang=en-EN,en'] };\r\nconst _puppeteerWrapper = new PuppeteerWrapper(_logger, _filePaths, _puppeteerConfig);\r\n//#endregion\r\n\r\nconst countryCode = 'FI';\r\n\r\n//#region Main ---------------------------------------------------------------------\r\n\r\nasync function main() {\r\n\tconst searchLimit = parseInt(process.argv[2] || 0);\r\n\tconst cities = await Model.CityName.findAll();\r\n\tconst categories = await Model.CategoryName.findAll();\r\n\tconst keywords = [];\r\n\r\n\tcities.forEach(async (city) => {\r\n\t\tcategories.forEach(async (category) => {\r\n\t\t\tconst searchQuery = `${category.name} in ${city.name}, Finland`;\r\n\t\t\tkeywords.push({\r\n\t\t\t\tquery: searchQuery,\r\n\t\t\t\tcity: city.id,\r\n\t\t\t\tcategory: category.id,\r\n\t\t\t});\r\n\t\t});\r\n\t});\r\n\r\n\tfor (let i = 0; i < keywords.length; i++) {\r\n\t\tconst keyword = keywords[i];\r\n\r\n\t\tawait GMapScrapper(keyword.query, searchLimit, keyword.city, keyword.category);\r\n\t\tawait delay.range(1000, 6000);\r\n\t}\r\n}\r\n\r\nconst changeLocation = async (countryCode, page) => {\r\n\tconst locationMenuSelector = 'button[jsaction=\"fineprint.country\"]';\r\n\r\n\tawait page.waitForSelector(locationMenuSelector);\r\n\tawait page.click(locationMenuSelector);\r\n\r\n\tconst moreRegionLinkSelector = 'a#regionanchormore';\r\n\tawait page.waitForSelector(moreRegionLinkSelector, { waitUntil: 'networkidle2' });\r\n\tawait page.waitForTimeout(1000);\r\n\tawait page.click(moreRegionLinkSelector);\r\n\r\n\tawait page.waitForSelector('#regionother');\r\n\r\n\tawait page.waitForTimeout(1000);\r\n\r\n\tawait page.click(`div[data-value=\"${countryCode}\"`);\r\n\tawait page.waitForTimeout(1000);\r\n\tawait page.click('div.jfk-button:nth-child(1)');\r\n}\r\n\r\nconst changeLanguage = async (page) => {\r\n\tconst locationMenuSelector = 'button[jsaction=\"fineprint.country\"]';\r\n\r\n\tawait page.waitForSelector(locationMenuSelector);\r\n\tawait page.click(locationMenuSelector);\r\n\r\n\tawait page.waitForTimeout(1000);\r\n\r\n\tawait page.waitForSelector('a[aria-controls=\"langSec\"]');\r\n\tawait page.click('a[aria-controls=\"langSec\"]');\r\n\r\n\tawait page.waitForTimeout(1000);\r\n\r\n\tawait page.waitForSelector('a#langanchormore');\r\n\tawait page.click(`div[data-value=\"en\"`);\r\n\r\n\tawait page.waitForTimeout(1000);\r\n\r\n\tawait page.click('div.jfk-button:nth-child(1)');\r\n}\r\n\r\nconst getPageData = async (url, page) => {\r\n\tconsole.log(`Processing ${url}...`);\r\n\r\n\tawait page.goto(url);\r\n\r\n\t//Shop Name\r\n\tawait page.waitForSelector(\".x3AX1-LfntMc-header-title-title span\");\r\n\tconst itemName = await page.$eval(\r\n\t\tcssSelector['shop_name'],\r\n\t\t(name) => name.textContent\r\n\t);\r\n\r\n\tawait page.waitForSelector(\".x3AX1-LfntMc-header-title-ij8cu-haAclf\");\r\n\tconst reviewRating = await page.$eval(\r\n\t\tcssSelector['rating'],\r\n\t\t(rating) => rating.textContent\r\n\t);\r\n\r\n\tlet reviewCount = 0;\r\n\ttry {\r\n\t\tawait page.waitForSelector(\".h0ySl-wcwwM-E70qVe-list\");\r\n\t\treviewCount = parseInt(await page.$eval(\r\n\t\t\tcssSelector['reviews'],\r\n\t\t\t(review) => review.textContent\r\n\t\t));\r\n\t} catch (exception) {\r\n\t\tconsole.error(\"No reviews found.\");\r\n\t}\r\n\r\n\t//Shop Address\r\n\tawait page.waitForSelector(\".QSFF4-text.gm2-body-2:nth-child(1)\");\r\n\tlet address = await page.$$eval(\r\n\t\tcssSelector['address'],\r\n\t\t(divs) =>\r\n\t\t\tArray.from(divs)\r\n\t\t\t\t.map((div) => div.innerText)\r\n\t\t\t\t.find((address) => address)\r\n\t);\r\n\r\n\tif (address === undefined) {\r\n\t\taddress = await page.$$eval(\r\n\t\t\tcssSelector['address_backup'],\r\n\t\t\t(divs) => divs[1]\r\n\t\t);\r\n\t}\r\n\r\n\t//Website\r\n\ttry {\r\n\t\tawait page.waitForSelector(cssSelector['website'], { timeout: 3 });\r\n\t} catch (ex) {\r\n\t\tconsole.log('No element found.');\r\n\t}\r\n\r\n\tconst website = await page.$$eval(\r\n\t\tcssSelector['website'],\r\n\t\t(divs) =>\r\n\t\t\tArray.from(divs)\r\n\t\t\t\t.map((div) => div.innerText)\r\n\t\t\t\t.find((link) =>\r\n\t\t\t\t\t/^((https?|ftp|smtp):\\/\\/)?(www.)?[a-z0-9]+(\\.[a-z]{2,}){1,3}(#?\\/?[a-zA-Z0-9#]+)*\\/?(\\?[a-zA-Z0-9-_]+=[a-zA-Z0-9-%]+&?)?$/.test(\r\n\t\t\t\t\t\tlink\r\n\t\t\t\t\t)\r\n\t\t\t\t)\r\n\t);\r\n\r\n\tconsole.log(website || 'No website');\r\n\r\n\tconst phone = await page.$$eval(\r\n\t\tcssSelector['phone'],\r\n\t\t(divs) =>\r\n\t\t\tArray.from(divs)\r\n\t\t\t\t.map((div) => div.innerText)\r\n\t\t\t\t.find((phone) => phone)\r\n\t);\r\n\r\n\tconsole.log(phone || 'No phone');\r\n\r\n\tconst latLong = getLatLong(url);\r\n\r\n\t//Hours of works\r\n\tconst workHours = JSON.stringify(await getWorkHours(page));\r\n\r\n\t//Images\r\n\tconst images = await getImages(page);\r\n\r\n\t//Reviews\r\n\tconst allReviews = await getReviews(page);\r\n\r\n\tlet returnObj = {};\r\n\r\n\ttry {\r\n\t\treturnObj = {\r\n\t\t\tname: itemName.trim(),\r\n\t\t\trating: reviewRating === undefined ? '' : reviewRating.trim(),\r\n\t\t\treviews: reviewCount,\r\n\t\t\taddress: address === undefined ? '' : address.trim(),\r\n\t\t\twebsite: website === undefined ? '' : website.trim(),\r\n\t\t\tphone: phone === undefined ? '' : phone.trim().replace(/\\-/g, ''),\r\n\t\t\tlatitude: (latLong[0] || \"\").toString().substring(0, 15),\r\n\t\t\tlongitude: (latLong[1] || \"\").toString().substring(0, 15),\r\n\t\t\tmain_image: images[0] || '',\r\n\t\t\tall_images: images,\r\n\t\t\tall_reviews: allReviews,\r\n\t\t\tworkHours: workHours,\r\n\t\t};\r\n\t} catch (exception) {\r\n\t\tconsole.log(exception);\r\n\t}\r\n\r\n\treturn returnObj;\r\n}\r\n\r\nconst getImages = async (page) => {\r\n\ttry {\r\n\t\tconsole.log(\"Getting images...\");\r\n\r\n\t\tawait page.waitForSelector('button[jsaction=\"pane.heroHeaderImage.click\"]', {timeout: 5000});\r\n\t\tawait page.click('button[jsaction=\"pane.heroHeaderImage.click\"]');\r\n\t\tawait page.waitForNavigation({ waitUntil: \"networkidle0\" });\r\n\r\n\t\tlet newScrollHeight = 0;\r\n\t\tlet scrollHeight = _puppeteerConfig['height'] - 200;\r\n\t\t// let divSelector = \"#pane > div > div > div > div > div:nth-child(4) > div\";\r\n\t\tlet divSelector = '#pane .siAUzd-neVct.section-scrollbox.cYB2Ge-oHo7ed.cYB2Ge-ti6hGc';\r\n\r\n\t\twhile (true) {\r\n\t\t\tawait page.waitForSelector(divSelector);\r\n\r\n\t\t\tawait page.evaluate(\r\n\t\t\t\t(scrollHeight, divSelector) =>\r\n\t\t\t\t\tdocument.querySelector(divSelector).scrollTo(0, scrollHeight),\r\n\t\t\t\tscrollHeight,\r\n\t\t\t\tdivSelector\r\n\t\t\t);\r\n\r\n\t\t\tawait page.waitForTimeout(800);\r\n\r\n\t\t\tnewScrollHeight = await page.$eval(\r\n\t\t\t\tdivSelector,\r\n\t\t\t\t(div) => div.scrollHeight\r\n\t\t\t);\r\n\r\n\t\t\tif (scrollHeight === newScrollHeight) {\r\n\t\t\t\tbreak;\r\n\t\t\t} else {\r\n\t\t\t\tscrollHeight = newScrollHeight;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst images = await page.$$eval(\r\n\t\t\t'a[data-photo-index] div.loaded',\r\n\t\t\t(divs) => {\r\n\t\t\t\treturn Array.from(divs)\r\n\t\t\t\t\t.map((div) => getComputedStyle(div).backgroundImage.replace('url(', '').replace(')', '').replaceAll('\"', ''));\r\n\t\t\t}\r\n\t\t);\r\n\r\n\t\tconsole.log(\"Images: \", images);\r\n\r\n\t\tawait page.waitForTimeout(2000);\r\n\t\tawait page.click('button[jsaction=\"pane.topappbar.back;focus:pane.focusTooltip;blur:pane.blurTooltip\"]');\r\n\t\tawait page.waitForNavigation({ waitUntil: \"networkidle0\" });\r\n\r\n\t\treturn images;\r\n\t} catch (ex) {\r\n\t\tconsole.error(ex);\r\n\t\treturn [];\r\n\t}\r\n}\r\n\r\nconst getReviews = async (page) => {\r\n\ttry {\r\n\t\tconst btnTriggerSelector = 'button[jsaction=\"pane.rating.moreReviews\"]';\r\n\r\n\t\tawait page.waitForSelector(btnTriggerSelector, {timeout: 5000});\r\n\t\tawait page.click(btnTriggerSelector);\r\n\t\tawait page.waitForNavigation({ waitUntil: \"networkidle0\" });\r\n\r\n\t\tlet newScrollHeight = 0;\r\n\t\tlet scrollHeight = _puppeteerConfig['height'] - 200;\r\n\t\t// let divSelector = \"#pane > div > div > div > div > div:nth-child(4) > div\";\r\n\t\tlet divSelector = '#pane .siAUzd-neVct.section-scrollbox.cYB2Ge-oHo7ed.cYB2Ge-ti6hGc';\r\n\r\n\t\twhile (true) {\r\n\t\t\tawait page.waitForSelector(divSelector, { timeout: 4000 });\r\n\r\n\t\t\tawait page.evaluate(\r\n\t\t\t\t(scrollHeight, divSelector) =>\r\n\t\t\t\t\tdocument.querySelector(divSelector).scrollTo(0, scrollHeight),\r\n\t\t\t\tscrollHeight,\r\n\t\t\t\tdivSelector\r\n\t\t\t);\r\n\r\n\t\t\tawait page.waitForTimeout(1000);\r\n\r\n\t\t\tnewScrollHeight = await page.$eval(\r\n\t\t\t\tdivSelector,\r\n\t\t\t\t(div) => div.scrollHeight\r\n\t\t\t);\r\n\r\n\t\t\tif (scrollHeight === newScrollHeight) {\r\n\t\t\t\tbreak;\r\n\t\t\t} else {\r\n\t\t\t\tscrollHeight = newScrollHeight;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tawait page.$$eval('[jsaction=\"pane.review.expandReview\"]', async (elHandles) => {\r\n\t\t\telHandles.forEach(el => el.click());\r\n\t\t\tawait delay(700);\r\n\t\t});\r\n\r\n\t\tconst reviews = await page.$$eval(\r\n\t\t\t'div.ODSEW-ShBeI-content',\r\n\t\t\t(divs) => Array.from(divs)\r\n\t\t\t\t.map((div) => {\r\n\t\t\t\t\tconst replaceString = {\r\n\t\t\t\t\t\t\"setahun\": \"a year\",\r\n\t\t\t\t\t\t\"sebulan\": \"a month\",\r\n\t\t\t\t\t\t\"seminggu\": \"a week\",\r\n\t\t\t\t\t\t\"sehari\": \"a day\",\r\n\t\t\t\t\t\t\"sejam\": \"an hour\",\r\n\t\t\t\t\t\t\"semenit\": \"a minute\",\r\n\t\t\t\t\t\t\"tahun\": \"years\",\r\n\t\t\t\t\t\t\"bulan\": \"months\",\r\n\t\t\t\t\t\t\"minggu\": \"weeks\",\r\n\t\t\t\t\t\t\"hari\": \"days\",\r\n\t\t\t\t\t\t\"jam\": \"hours\",\r\n\t\t\t\t\t\t\"menit\": \"minutes\",\r\n\t\t\t\t\t\t\"lalu\": \"ago\"\r\n\t\t\t\t\t};\r\n\t\t\t\t\tlet dateInEnglish = div.querySelector('.ODSEW-ShBeI-content span.ODSEW-ShBeI-RgZmSc-date').innerText.trim();\r\n\r\n\t\t\t\t\tfor (const key in replaceString) {\r\n\t\t\t\t\t\tif (Object.hasOwnProperty.call(replaceString, key)) {\r\n\t\t\t\t\t\t\tconst replacement = replaceString[key];\r\n\t\t\t\t\t\t\tdateInEnglish = dateInEnglish.replace(key, replacement);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tconst reviewText = div.querySelector('.ODSEW-ShBeI-content .ODSEW-ShBeI-text').innerText.trim();\r\n\t\t\t\t\tconst startTrimIndex = reviewText.indexOf('(Original)') + 10;\r\n\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\tauthor: div.querySelector('.ODSEW-ShBeI-content .ODSEW-ShBeI-title span').innerText.trim(),\r\n\t\t\t\t\t\ttitle: div.querySelector('.ODSEW-ShBeI-content .ODSEW-ShBeI-title span').innerText.trim(),\r\n\t\t\t\t\t\tavatar: div.querySelector('.ODSEW-ShBeI-content a[target^=\"_blank\"] img').getAttribute('src').trim(),\r\n\t\t\t\t\t\trating: div.querySelector('.ODSEW-ShBeI-content span.ODSEW-ShBeI-H1e3jb').getAttribute('aria-label').replace('stars', '').replace('bintang', '').trim(),\r\n\t\t\t\t\t\ttext: reviewText.substring(startTrimIndex).trim(),\r\n\t\t\t\t\t\tdate: dateInEnglish,\r\n\t\t\t\t\t};\r\n\t\t\t\t})\r\n\t\t);\r\n\r\n\t\tawait page.waitForTimeout(2000);\r\n\t\tawait page.click('button.VfPpkd-icon-LgbsSe.yHy1rc.eT1oJ');\r\n\t\tawait page.waitForNavigation({ waitUntil: \"networkidle0\" });\r\n\r\n\t\tconst reviewData = [];\r\n\r\n\t\tfor (let i = 0; i < reviews.length; i++) {\r\n\t\t\tconst review = reviews[i];\r\n\t\t\treview['date'] = moment(datejs(review['date'])).format('YYYY-MM-DD HH:mm:ss').toString();\r\n\t\t\treviewData.push(review);\r\n\t\t}\r\n\r\n\t\t// console.log(\"Reviews data: \", reviewData);\r\n\r\n\t\treturn reviewData;\r\n\t} catch (ex) {\r\n\t\tconsole.error(ex);\r\n\t\treturn [];\r\n\t}\r\n}\r\n\r\nconst getWorkHours = async (page) => {\r\n\ttry {\r\n\t\tconst tableSelector = 'table.y0skZc-jyrRxf-Tydcue.NVpwyf-qJTHM-ibL1re';\r\n\r\n\t\tawait page.waitForSelector(tableSelector, {timeout: 5000});\r\n\r\n\t\tconst workHours = await page.$$eval(\r\n\t\t\t`${tableSelector} tr`,\r\n\t\t\t(divs) => Array.from(divs)\r\n\t\t\t\t.map((div) => {\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\t[div.querySelector('td:nth-child(1)').innerText.trim()]: div.querySelector('td:nth-child(2) ul').innerText.trim(),\r\n\t\t\t\t\t};\r\n\t\t\t\t})\r\n\t\t);\r\n\r\n\t\treturn workHours;\r\n\t} catch (ex) {\r\n\t\tconsole.error(\"No work hours found.\");\r\n\r\n\t\treturn [];\r\n\t}\r\n}\r\n\r\n//Get Links\r\nconst getLinks = async (page) => {\r\n\t// Scrolling to bottom of page\r\n\tlet newScrollHeight = 0;\r\n\tlet scrollHeight = _puppeteerConfig['height'];\r\n\tlet divSelector = '#pane > div > div > div > div > div > div[role=\"region\"]:nth-child(1)';\r\n\r\n\twhile (true) {\r\n\t\tawait page.waitForSelector(divSelector);\r\n\r\n\t\tawait page.evaluate(\r\n\t\t\t(scrollHeight, divSelector) =>\r\n\t\t\t\tdocument.querySelector(divSelector).scrollTo(0, scrollHeight),\r\n\t\t\tscrollHeight,\r\n\t\t\tdivSelector\r\n\t\t);\r\n\r\n\t\tawait page.waitForTimeout(1000);\r\n\r\n\t\tnewScrollHeight = await page.$eval(\r\n\t\t\tdivSelector,\r\n\t\t\t(div) => div.scrollHeight\r\n\t\t);\r\n\r\n\t\tif (scrollHeight === newScrollHeight) {\r\n\t\t\tbreak;\r\n\t\t} else {\r\n\t\t\tscrollHeight = newScrollHeight;\r\n\t\t}\r\n\t}\r\n\r\n\t// Get results\r\n\tconst searchResults = await page.evaluate(() =>\r\n\t\tArray.from(document.querySelectorAll(\"a\"))\r\n\t\t\t.map((el) => el.href)\r\n\t\t\t.filter(\r\n\t\t\t\t(link) =>\r\n\t\t\t\t\tlink.match(/https:\\/\\/www.google.com\\/maps\\//g, link) &&\r\n\t\t\t\t\t!link.match(/\\=https:\\/\\/www.google.com\\/maps\\//g, link)\r\n\t\t\t)\r\n\t);\r\n\r\n\treturn searchResults;\r\n}\r\n\r\nconst getLatLong = (url) => {\r\n\tlet latLongStartIndex = url.indexOf('!3d') + 4;\r\n\tlet latLongEndIndex = url.indexOf('?');\r\n\tlet latLongData = url.substring(latLongStartIndex, latLongEndIndex).split('!4d');\r\n\r\n\tif (isNaN(latLongData[0]) || isNaN(latLongData[1])) {\r\n\t\tlatLongStartIndex = url.indexOf('/@') + 2;\r\n\t\tlatLongEndIndex = url.indexOf(',15z');\r\n\t\tlatLongData = url.substring(latLongStartIndex, latLongEndIndex).split(\",\");\r\n\t}\r\n\r\n\treturn latLongData;\r\n}\r\n\r\nconst slugify = (str) => {\r\n\tstr = str.replace(/^\\s+|\\s+$/g, ''); // trim\r\n\tstr = str.toLowerCase();\r\n\r\n\t// remove accents, swap ñ for n, etc\r\n\tvar from = \"àáäâèéëêìíïîòóöôùúüûñç·/_,:;\";\r\n\tvar to = \"aaaaeeeeiiiioooouuuunc------\";\r\n\tfor (var i = 0, l = from.length; i < l; i++) {\r\n\t\tstr = str.replace(new RegExp(from.charAt(i), 'g'), to.charAt(i));\r\n\t}\r\n\r\n\tstr = str.replace(/[^a-z0-9 -]/g, '') // remove invalid chars\r\n\t\t.replace(/\\s+/g, '-') // collapse whitespace and replace by -\r\n\t\t.replace(/-+/g, '-'); // collapse dashes\r\n\r\n\treturn str;\r\n}\r\n\r\nasync function GMapScrapper(searchQuery, maxLinks = 100, city, category) {\r\n\tconsole.log(`Start scrapping data with query \"${searchQuery}\"`);\r\n\r\n\tconst page = await _puppeteerWrapper.newPage();\r\n\r\n\tconst gmapInitUrl = \"https://www.google.com/maps?t=\" + Date.now();\r\n\r\n\tpage.on('response', response => {\r\n\t\tconst status = response.status();\r\n\t\tif ((status >= 300) && (status <= 399)) {\r\n\t\t\tconsole.log('Redirect from', response.url(), 'to', response.headers()['location'])\r\n\t\t}\r\n\t});\r\n\r\n\tpage.on('dialog', async dialog => {\r\n\t\tawait delay(1000);\r\n\t\tawait dialog.accept();\r\n\t});\r\n\r\n\ttry {\r\n\t\tawait page.goto(gmapInitUrl, { waitUntil: 'networkidle0' });\r\n\t\tawait changeLocation(countryCode, page);\r\n\t\tawait changeLanguage(page);\r\n\t} catch (ex) {\r\n\t\tconsole.log(ex);\r\n\t\tawait page.waitForTimeout(800);\r\n\t\tawait page.reload({ waitUntil: [\"networkidle0\", \"domcontentloaded\"] });\r\n\t}\r\n\r\n\tawait page.waitForNavigation({ waitUntil: \"domcontentloaded\" });\r\n\tawait page.waitForSelector('div#gs_lc50 input#searchboxinput');\r\n\r\n\tawait page.type('div#gs_lc50 input#searchboxinput', searchQuery, { delay: 10 });\r\n\tawait page.keyboard.press('Enter');\r\n\r\n\tlet allLinks = [];\r\n\tlet linkCount = 0;\r\n\r\n\twhile (\r\n\t\t!(await page.$$eval(\r\n\t\t\t\"#pane > div > div > div > div > div > div > div\",\r\n\t\t\t(elements) =>\r\n\t\t\t\tArray.from(elements).some(\r\n\t\t\t\t\t(el) => (el.innerText === \"Tidak ditemukan hasil\" || el.innerText === \"No results found\")\r\n\t\t\t\t)\r\n\t\t))\r\n\t) {\r\n\t\tif (maxLinks !== 0 && linkCount > maxLinks) break;\r\n\r\n\t\tallLinks.push(...(await getLinks(page)));\r\n\r\n\t\tawait page.$$eval(\"button\", (elements) => {\r\n\t\t\treturn Array.from(elements)\r\n\t\t\t\t.find((el) => (el.getAttribute(\"jsaction\") === \"pane.paginationSection.nextPage\" || el.getAttribute(\"aria-label\") === \"Next page\"))\r\n\t\t\t\t.click()\r\n\t\t});\r\n\r\n\r\n\t\ttry {\r\n\t\t\tawait page.waitForNavigation({ waitUntil: \"load\", timeout: 3000 });\r\n\t\t} catch (ex) {\r\n\t\t\tbreak;\r\n\t\t}\r\n\r\n\t\tlinkCount = allLinks.length;\r\n\r\n\t\tconsole.log(`Links count: ${linkCount}`);\r\n\t}\r\n\r\n\tconsole.log(\"Validating results...\");\r\n\r\n\tconsole.log(\"All Links \", allLinks.length);\r\n\r\n\tlet uniqueLinks = allLinks.filter(function (value, index, self) {\r\n\t\treturn self.indexOf(value) === index;\r\n\t});\r\n\r\n\tif (maxLinks > 0) {\r\n\t\tuniqueLinks = uniqueLinks.slice(0, maxLinks);\r\n\t}\r\n\r\n\tawait delay(2000);\r\n\r\n\tconsole.log(\"Filtered Links \", uniqueLinks.length);\r\n\r\n\tlet no = 1;\r\n\tlet successCount = 0;\r\n\tlet failedCount = 0;\r\n\tfor (let link of uniqueLinks) {\r\n\t\tif (maxLinks !== 0 && no > maxLinks) break;\r\n\r\n\t\tconsole.log('#' + no + ' Processing: \"' + link + '...');\r\n\r\n\t\ttry {\r\n\t\t\tconst item = await Model.Item.findOne({ where: { link: link } });\r\n\t\t\tif (item == null) {\r\n\t\t\t\tconst data = await getPageData(link, page);\r\n\t\t\t\tconst item = await Model.Item.create({\r\n\t\t\t\t\tname: data.name,\r\n\t\t\t\t\tslug: slugify(data.name),\r\n\t\t\t\t\taddress: data.address,\r\n\t\t\t\t\tlatitude: data.latitude,\r\n\t\t\t\t\tlongitude: data.longitude,\r\n\t\t\t\t\taddress: data.address,\r\n\t\t\t\t\thours_of_work: data.workHours,\r\n\t\t\t\t\twebsite: data.website,\r\n\t\t\t\t\timage_remote: data.main_image,\r\n\t\t\t\t\timage: data.main_image,\r\n\t\t\t\t\tdate_created: moment().format('YYYY-MM-DD HH:mm:ss').toString(),\r\n\t\t\t\t\titem_city: city,\r\n\t\t\t\t\tlink: link,\r\n\t\t\t\t});\r\n\r\n\t\t\t\tconsole.log(\"Item created: \", item);\r\n\r\n\t\t\t\tawait Model.City.create({\r\n\t\t\t\t\tcities_names_id: city,\r\n\t\t\t\t\titems_id: item.id,\r\n\t\t\t\t});\r\n\r\n\t\t\t\tconst existingItemCategory = await Model.Category.findOne({ where: { items_id: item.id } });\r\n\t\t\t\tif (existingItemCategory == null) {\r\n\t\t\t\t\tawait Model.Category.create({\r\n\t\t\t\t\t\tcategories_names_id: category,\r\n\t\t\t\t\t\titems_id: item.id,\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\r\n\t\t\t\tfor (let i = 0; i < data.all_images.length; i++) {\r\n\t\t\t\t\tconst imageUrl = data.all_images[i];\r\n\r\n\t\t\t\t\tconst existingImage = await Model.Image.findOne({ where: { items_id: item.id, url: imageUrl } });\r\n\t\t\t\t\tif (existingImage == null) {\r\n\t\t\t\t\t\tawait Model.Image.create({\r\n\t\t\t\t\t\t\titems_id: item.id,\r\n\t\t\t\t\t\t\turl: imageUrl,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tfor (let i = 0; i < data.all_reviews.length; i++) {\r\n\t\t\t\t\tconst review = data.all_reviews[i];\r\n\r\n\t\t\t\t\tconst existingReview = await Model.Comment.findOne({ where: { items_id: item.id, author: review.author, text: review.text } });\r\n\t\t\t\t\tif (existingReview == null) {\r\n\t\t\t\t\t\tawait Model.Comment.create({\r\n\t\t\t\t\t\t\titems_id: item.id,\r\n\t\t\t\t\t\t\ttitle: item.title,\r\n\t\t\t\t\t\t\tauthor: review.author,\r\n\t\t\t\t\t\t\ttext: review.text,\r\n\t\t\t\t\t\t\trating: review.rating || 0,\r\n\t\t\t\t\t\t\tavatar: review.avatar,\r\n\t\t\t\t\t\t\tdate: review.date,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tno++;\r\n\t\t\tsuccessCount++;\r\n\t\t} catch (ex) {\r\n\t\t\tconsole.error(ex);\r\n\t\t\tfailedCount++;\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tawait delay.range(100, 1000);\r\n\t}\r\n\r\n\tawait _puppeteerWrapper.cleanup();\r\n\r\n\tconst doneMessage = `Done scraping processes with keywords \"${searchQuery}\". Here is the statistic data: ${successCount} success, ${failedCount} failed\\n`;\r\n\r\n\tconsole.log(doneMessage);\r\n}\r\n\r\n(async () => {\r\n\ttry {\r\n\t\tconst chromeSet = await _puppeteerWrapper.setup();\r\n\t\tif (!chromeSet) {\r\n\t\t\tconsole.error(\"Chrome not found!\");\r\n\t\t} else {\r\n\t\t\tconsole.log(_puppeteerWrapper._getSavedPath());\r\n\t\t}\r\n\r\n\t\tawait main();\r\n\t} catch (e) {\r\n\t\t_logger.logError('Thrown error:');\r\n\t\t_logger.logError(e);\r\n\t} finally {\r\n\t\tawait _puppeteerWrapper.cleanup();\r\n\t}\r\n\r\n\tconsole.log('Done. Close application process.');\r\n\r\n\tawait _logger.exportLogs(_filePaths.logsPath());\r\n})();\r\n\r\n//#endregion\r\n"]}